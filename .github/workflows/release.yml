name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'pom.xml'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from pom.xml
        id: version
        run: |
          VERSION=$(grep "<version>" pom.xml | head -1 | sed "s/.*<version>\([^<]*\)<\/version>.*/\1/")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=v$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag does not exist, proceeding with release"
          fi

      - name: Set up Java
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        if: steps.check_tag.outputs.exists == 'false'
        id: build
        continue-on-error: true
        run: mvn clean package -DskipTests=true

      - name: Capture build logs on failure
        if: steps.build.outcome == 'failure'
        id: build_logs
        run: |
          LOGS=$(mvn clean package -DskipTests=true 2>&1 | tail -150)
          echo "LOGS<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create issue on build failure
        if: steps.build.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          BUILD_LOGS: ${{ steps.build_logs.outputs.LOGS }}
        with:
          script: |
            const version = '${{ steps.version.outputs.VERSION }}';
            const buildLogs = process.env.BUILD_LOGS;
            const commitSha = context.sha.substring(0, 7);
            const repoUrl = 'https://github.com/${{ github.repository }}';
            const commitUrl = repoUrl + '/commit/${{ github.sha }}';
            const workflowUrl = repoUrl + '/actions/runs/${{ github.run_id }}';
            
            const body = `## Build Failure Report

            **Version:** \`${version}\`
            **Commit:** [\`${commitSha}\`](${commitUrl})
            **Triggered by:** @${{ github.actor }}

            ### Build Error
            \`\`\`
            ${buildLogs}
            \`\`\`

            ### Actions Required
            1. Review the build errors above
            2. Fix the issues in the code
            3. Update the version in \`pom.xml\` and push again

            [View Workflow Run](${workflowUrl})
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âŒ Build Failed - Version ${version}`,
              body: body,
              labels: ['bug', 'build-failure']
            });

      - name: Fail workflow on build error
        if: steps.build.outcome == 'failure'
        run: exit 1

      - name: Get previous tag
        id: prev_tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.PREV_TAG }}"
          CURRENT_TAG="${{ steps.version.outputs.TAG }}"
          
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %h: %s (%an)" | head -5)
            COMMIT_COUNT=$(git log --oneline | wc -l)
            if [ "$COMMIT_COUNT" -gt 5 ]; then
              CHANGELOG="$CHANGELOG"$'\n\n'"[View all commits](https://github.com/${{ github.repository }}/commits/$CURRENT_TAG)"
            fi
          else
            COMMIT_COUNT=$(git rev-list --count $PREV_TAG..$CURRENT_TAG 2>/dev/null || echo 0)
            if [ "$COMMIT_COUNT" -gt 5 ]; then
              CHANGELOG=$(git log $PREV_TAG..HEAD --oneline --pretty=format:"- %h: %s (%an)" | head -5)
              ADDITIONAL_COUNT=$((COMMIT_COUNT - 5))
              CHANGELOG="$CHANGELOG"$'\n\n'"**+ $ADDITIONAL_COUNT more commits**"$'\n\n'"[View all changes between $PREV_TAG and $CURRENT_TAG](https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG)"
            else
              CHANGELOG=$(git log $PREV_TAG..HEAD --oneline --pretty=format:"- %h: %s (%an)")
            fi
          fi
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a ${{ steps.version.outputs.TAG }} -m "Release ${{ steps.version.outputs.TAG }}"

      - name: Push tag
        if: steps.check_tag.outputs.exists == 'false'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tags: true

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: target/FarmweltPlugin-*.jar
          tag_name: ${{ steps.version.outputs.TAG }}
          name: FarmweltPlugin ${{ steps.version.outputs.TAG }}
          body: |
            # FarmweltPlugin ${{ steps.version.outputs.TAG }}
            
            ## What's New
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## Installation
            1. Download the JAR file below
            2. Place it in your server's `plugins` folder
            3. Restart your server
            
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
